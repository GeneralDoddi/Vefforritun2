var app=angular.module("ChatApp",["ngRoute","ui.bootstrap"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/default.html",controller:"LoginController"}).when("/room/:roomName",{templateUrl:"templates/room.html",controller:"RoomController"}).otherwise({redirectTo:"/"})}]),app.factory("SocketService",["$http",function(){var a,b="",c=[],d=[];return{setConnected:function(b){a=b},setUsername:function(a){b=a},getUsername:function(){return b},getSocket:function(){return a},setRoom:function(a){c.push(a)},getRoom:function(){return c},partRoom:function(a){c.splice(c.indexOf(a),1)},roomExists:function(a){for(var b=c.length-1;b>=0;b--)if(c[b]===a)return!0;return!1},getPrivchat:function(){return d},setPrivchat:function(a){d.push(a)},exitChat:function(a){d.splice(d.indexOf(a),1)},chatExists:function(a){for(var b=d.length-1;b>=0;b--)if(d[b]===a)return!0;return!1}}}]);var LoginPartialController=function(a,b,c,d){var e=io.connect("http://localhost:8080");a.username="",a.message="",a.input={},a.connect=function(){console.log(a.input.abc),console.log("Hello from login3"),e&&e.emit("adduser",a.input.abc,function(f){f?(c.setConnected(e),c.setUsername(a.input.abc),c.setRoom("lobby"),b.path("/room/lobby"),a.$apply(),d.dismiss()):(console.log("herro from error"),a.message="Your name is taken, please choose another name")})},a.keyPress=function(b){13===b.keyCode&&a.connect()}},ModalInstanceCtrl=function(a,b,c,d,e,f){a.roomName="",a.roomList=d,a.input={},a.createRoom=function(){console.log("Creating a new room"),console.log(a.input.roomName),e.emit("joinroom",{room:a.roomname,pass:""},function(){f.roomExists(a.input.roomName)===!1&&(f.setRoom(a.input.roomName),console.log("accepted"),c.path("/room/"+chatMsg[1])),b.dismiss()})},a.cancel=function(){b.dismiss("cancel")}};app.controller("LoginController",function(a,b,c,d){console.log("hello from modal login");d.open({templateUrl:"templates/home.html",controller:"LoginPartialController",backdrop:"static"})}),app.controller("RoomController",["$scope","$location","$routeParams","SocketService","$modal","$log",function(a,b,c,d,e,f){a.roomName=c.roomName,a.currentMessage="",a.roomList=d.getRoom(),a.username=d.getUsername(),a.privChat=d.getPrivchat();var g=d.getSocket();g&&(g.emit("joinroom",{room:a.roomName,pass:""},function(){d.roomExists(a.roomName)===!1&&d.setRoom(a.roomName)}),g.on("updatechat",function(b,c){b===a.roomName&&(console.log(c),a.messages=c,a.$apply())}),g.on("updateusers",function(b,c,d){b===a.roomName&&(a.ops=d,a.users=c,a.$apply())}),g.on("kicked",function(c,e){e===a.username&&(d.partRoom(a.roomName),b.path("/room/lobby"))}),g.on("opped",function(b,c){c===a.username}),g.on("deopped",function(b,c){c===a.username}),g.on("banned",function(a,b){g.emit("kick",{room:a,user:b},function(){})}),g.on("exited",function(){b.path("/room/lobby")}),g.on("recv_privatemsg",function(a,b){d.chatExists(a)===!1&&d.setPrivchat(a),console.log(b)})),a.createRoom=function(){console.log("create new room");var b=e.open({templateUrl:"templates/newRoomPartial.html",controller:"ModalInstanceCtrl",backdrop:"static",resolve:{roomList:function(){return a.roomList},socket:function(){return d.getSocket()},setRoom:function(){return d.setRoom}}});b.result.then(function(){},function(){f.info("Modal dismissed at: "+new Date)})},a.send=function(){if(g){var c=a.currentMessage.split(" ");"/kick"===c[0]?(g.emit("kick",{room:a.roomName,user:c[1]},function(b){b&&g.emit("sendmsg",{roomName:a.roomName,msg:"Has kicked : "+c[1]})}),a.currentMessage=""):"/op"===c[0]?(g.emit("op",{room:a.roomName,user:c[1]},function(b){b&&g.emit("sendmsg",{roomName:a.roomName,msg:"Has opped "+c[1]})}),a.currentMessage=""):"/deop"===c[0]?(g.emit("deop",{room:a.roomName,user:c[1]},function(b){b&&g.emit("sendmsg",{roomName:a.roomName,msg:"Has deopped "+c[1]})}),a.currentMessage=""):"/ban"===c[0]?(g.emit("ban",{room:a.roomName,user:c[1]},function(b){b&&g.emit("sendmsg",{roomName:a.roomName,msg:"Has banned "+c[1]})}),a.currentMessage=""):"/unban"===c[0]?(g.emit("unban",{room:a.roomName,user:c[1]},function(b){b&&g.emit("sendmsg",{roomName:a.roomName,msg:"Has unbanned "+c[1]})}),a.currentMessage=""):"/joinroom"===c[0]?(d.roomExists(c[1])===!1&&(d.setRoom(c[1]),g.emit("joinroom",{room:c[1],pass:""},function(d){d?(b.path("/room/"+c[1]),a.$apply()):alert("you are banned from "+c[1])}),g.emit("op",{room:a.roomName,user:a.username},function(b){b&&a.$apply()})),a.currentMessage=""):"/partroom"===c[0]?"lobby"===a.roomName?alert("You must disconnect to leave lobby"):(c.shift(),g.emit("sendmsg",{roomName:a.roomName,msg:"Has left : "+c.join(" ")}),a.currentMessage="",d.partRoom(a.roomName),b.path("/room/lobby"),g.emit("partroom",a.roomName)):"/msg"===c[0]?(d.setPrivchat(c[1]),g.emit("privatemsg",{nick:c[1],message:c[2]},function(b){b&&a.$apply()}),a.currentMessage=""):(d.roomExists(a.roomName)===!0?(g.emit("sendmsg",{roomName:a.roomName,msg:a.currentMessage}),console.log("public msg")):d.chatExists(a.roomName)===!0&&(g.emit("privatemsg",{nick:a.roomName,message:a.currentMessage}),console.log("private msg")),a.currentMessage="")}},a.disconnect=function(){g&&(console.log(d.getUsername()+" Disconnected from server"),g.disconnect(),b.path("/"))},a.partRoom=function(b){console.log(b),"lobby"===b?alert("You must disconnect to leave lobby"):(console.log("delete "+b),d.partRoom(b),g.emit("exited",b,a.username),g.emit("partroom",b))},a.keyPress=function(b){console.log("$event"),13===b.keyCode&&a.send()}}]);
